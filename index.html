<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Shipment Tracking</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">
  <div class="container">
    <h2>Track Shipment</h2>
    <p>Masukkan Nomor BL atau Nomor Container</p>

    <div class="mb-3">
      <input id="q" class="form-control" placeholder="BL atau Container" />
    </div>
    <div class="mb-3">
      <button id="btnSearch" class="btn btn-primary">Cari</button>
      <button id="btnClear" class="btn btn-secondary">Reset</button>
    </div>

    <div id="result"></div>
  </div>

<script type="module">
  // 1) import firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // 2) Masukkan firebaseConfig kamu di sini
  const firebaseConfig = {
    apiKey: "REPLACE",
    authDomain: "REPLACE",
    projectId: "REPLACE",
    storageBucket: "REPLACE",
    messagingSenderId: "REPLACE",
    appId: "REPLACE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const qInput = document.getElementById('q');
  const btnSearch = document.getElementById('btnSearch');
  const btnClear = document.getElementById('btnClear');
  const result = document.getElementById('result');

  function renderShipment(doc, tracking) {
    const container = document.createElement('div');
    container.className = 'card mb-3';
    container.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">BL: ${doc.blNumber || '-'} | Container: ${doc.containerNumber || '-'}</h5>
        <p class="card-text"><strong>Type:</strong> ${doc.type || '-'} • <strong>Origin:</strong> ${doc.origin||'-'} • <strong>Dest:</strong> ${doc.destination||'-'}</p>
        <h6>Tracking</h6>
        <ul class="list-group">${tracking.map(t=>`<li class="list-group-item"><strong>${new Date(t.date.seconds*1000).toLocaleString()}</strong> — ${t.title} <div>${t.detail||''}</div></li>`).join('')}</ul>
      </div>`;
    return container;
  }

  async function search(qval) {
    result.innerHTML = '<div class="text-muted">Mencari…</div>';
    // 2 queries: search by blNumber OR containerNumber
    const shipmentsRef = collection(db, 'shipments');

    // try BL exact match first
    const q1 = query(shipmentsRef, where('blNumber', '==', qval));
    const q2 = query(shipmentsRef, where('containerNumber', '==', qval));

    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const docs = [...snap1.docs, ...snap2.docs];

    // deduplicate
    const unique = new Map();
    docs.forEach(d => unique.set(d.id, d));
    result.innerHTML = '';
    if (unique.size === 0) {
      result.innerHTML = '<div class="alert alert-warning">Data tidak ditemukan.</div>';
      return;
    }

    // for each shipment, fetch tracking subcollection (simple approach: expect tracking array field OR subcollection)
    for (const [id, dSnap] of unique) {
      const data = dSnap.data();

      // Prefer 'tracking' array field (faster). If not exist, fallback to subcollection 'tracking'
      if (Array.isArray(data.tracking)) {
        // already sorted? ensure sort by date desc
        data.tracking.sort((a,b)=> b.date.seconds - a.date.seconds);
        result.appendChild(renderShipment(data, data.tracking));
      } else {
        // fallback: read subcollection (not implemented here to keep simple). Show basic info.
        result.appendChild(renderShipment(data, []));
      }
    }
  }

  btnSearch.addEventListener('click', ()=> {
    const val = qInput.value.trim();
    if (!val) return alert('Masukkan BL atau container.');
    search(val);
  });
  btnClear.addEventListener('click', ()=> { qInput.value=''; result.innerHTML=''; });
</script>
</body>
</html>
