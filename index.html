<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shipment Tracking â€” Search</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{margin:0;font-family:'Poppins',sans-serif;background:url('background.jpg') no-repeat center center fixed;background-size:cover;color:#fff;}
  .overlay{background:rgba(0,0,0,0.5);min-height:100vh;padding:30px;}
  .search-area{max-width:700px;margin:40px auto 0;text-align:center;}
  select,input,button{padding:10px;border-radius:6px;border:none;font-size:15px}
  select,input{width:60%;margin-right:6px}
  button{background:#ff9800;color:#fff;cursor:pointer}
  .loader{display:none;border:6px solid rgba(255,255,255,0.15);border-top:6px solid #ff9800;border-radius:50%;width:48px;height:48px;margin:18px auto;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .result-box{max-width:900px;margin:18px auto;background:rgba(255,255,255,0.06);padding:18px;border-radius:8px;display:none;color:#fff}
  .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px 28px}
  .label{font-weight:600;color:#ffdca2}
  .value{font-weight:400}
  .not-found{text-align:center;padding:18px;font-weight:600}
  .timeline{margin-top:16px;padding-left:18px;border-left:3px solid #ff9800}
  .timeline-item{margin-bottom:12px;position:relative}
  .timeline-item::before{content:'';position:absolute;left:-10px;top:3px;width:12px;height:12px;background:#ff9800;border-radius:50%}
  .logo{position:absolute;top:20px;right:20px;width:100px;animation:logoAnim 1.5s ease-in-out infinite alternate}
  @keyframes logoAnim{0%{transform:scale(1) rotate(0);opacity:0.8}50%{transform:scale(1.05) rotate(2deg);opacity:1}100%{transform:scale(1) rotate(-2deg);opacity:0.9}}
  @media(max-width:640px){select,input{width:100%;display:block;margin:6px 0} .result-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="overlay">
    <div class="search-area">
      <h2 style="color:#ffcc80;margin:0 0 12px">Shipment Tracking</h2>
      <div>
        <select id="modeSelect" aria-label="mode">
          <option value="export">Export (shipments)</option>
          <option value="import">Import (importShipments)</option>
        </select>
        <input id="blInput" placeholder="Masukkan Bill of Lading" />
        <button id="searchBtn">Cari</button>
      </div>

      <div id="loader" class="loader" role="status" aria-hidden="true"></div>
      <div id="resultBox" class="result-box" aria-live="polite"></div>
    </div>
  </div>

  <img src="logo.png" alt="Logo" class="logo">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // === firebase config (sama seperti admin) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBwIvGNogDk6nKCCcoWxmnvex4pbSIR07g",
      authDomain: "track-and-trace-ca19a.firebaseapp.com",
      projectId: "track-and-trace-ca19a",
      storageBucket: "track-and-trace-ca19a.appspot.com",
      messagingSenderId: "264766950053",
      appId: "1:264766950053:web:b871670f2ab2c10d0f1b4c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const modeSelect = document.getElementById('modeSelect');
    const blInput = document.getElementById('blInput');
    const searchBtn = document.getElementById('searchBtn');
    const loader = document.getElementById('loader');
    const resultBox = document.getElementById('resultBox');

    function showLoader(on){ loader.style.display = on ? 'block' : 'none'; }
    function showResult(html){ resultBox.style.display = html ? 'block' : 'none'; resultBox.innerHTML = html || ''; }

    searchBtn.addEventListener('click', async () => {
      const bl = blInput.value.trim();
      if (!bl) { alert('Masukkan nomor Bill of Lading'); blInput.focus(); return; }

      const mode = modeSelect.value;
      const collectionName = mode === 'export' ? 'shipments' : 'importShipments';

      showResult('');
      showLoader(true);

      try {
        const q = query(collection(db, collectionName), where('billOfLading', '==', bl));
        const snap = await getDocs(q);
        showLoader(false);

        if (snap.empty) {
          showResult('<div class="not-found">Data tidak ditemukan</div>');
          console.info(`No documents in ${collectionName} with billOfLading=${bl}`);
          return;
        }

        let htmlOut = '';
        snap.forEach(doc => {
          const data = doc.data();
          htmlOut += '<div class="result-grid">';
          if (mode === 'export') {
            htmlOut += `
              <div><span class="label">Bill Of Lading:</span> <div class="value">${data.billOfLading||''}</div></div>
              <div><span class="label">Vessel/Voyage:</span> <div class="value">${data.vesselVoyage||''}</div></div>
              <div><span class="label">ETA:</span> <div class="value">${data.eta||''}</div></div>
              <div><span class="label">Port Of Transit:</span> <div class="value">${data.portTransit||''}</div></div>
              <div><span class="label">Connecting Vessel:</span> <div class="value">${data.connectingVessel||''}</div></div>
              <div><span class="label">Port Of Destination:</span> <div class="value">${data.portDestination||''}</div></div>
              <div><span class="label">ETD:</span> <div class="value">${data.etd||''}</div></div>
              <div><span class="label">ETA POD:</span> <div class="value">${data.etaPod||''}</div></div>
              <div><span class="label">DO Release Date:</span> <div class="value">${data.doReleaseDate||''}</div></div>
              <div><span class="label">Cargo Release Date:</span> <div class="value">${data.cargoReleaseDate||''}</div></div>
            `;
          } else {
            htmlOut += `
              <div><span class="label">Bill Of Lading:</span> <div class="value">${data.billOfLading||''}</div></div>
              <div><span class="label">POL:</span> <div class="value">${data.pol||''}</div></div>
              <div><span class="label">POD:</span> <div class="value">${data.pod||''}</div></div>
              <div><span class="label">ETD:</span> <div class="value">${data.etd||''}</div></div>
              <div><span class="label">ETA:</span> <div class="value">${data.eta||''}</div></div>
              <div><span class="label">Incoterm:</span> <div class="value">${data.incoterm||''}</div></div>
              <div><span class="label">Type of Shipment:</span> <div class="value">${data.typeOfShipment||''}</div></div>
            `;
          }
          htmlOut += '</div>';

          // timeline (best-effort)
          htmlOut += '<div class="timeline">';
          if (data.etd) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.etd}</div><div class="timeline-text">Departed from origin</div></div>`;
          if (data.portTransit) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.eta||''}</div><div class="timeline-text">Arrived at transit port: ${data.portTransit}</div></div>`;
          if (data.connectingVessel) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.etd||''}</div><div class="timeline-text">Transferred to vessel: ${data.connectingVessel}</div></div>`;
          if (data.etaPod) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.etaPod}</div><div class="timeline-text">Expected arrival at destination port</div></div>`;
          if (data.doReleaseDate) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.doReleaseDate}</div><div class="timeline-text">DO Released</div></div>`;
          if (data.cargoReleaseDate) htmlOut += `<div class="timeline-item"><div class="timeline-date">${data.cargoReleaseDate}</div><div class="timeline-text">Cargo Released</div></div>`;
          htmlOut += '</div>';
        });

        showResult(htmlOut);
      } catch (err) {
        showLoader(false);
        showResult('<div class="not-found">Terjadi kesalahan saat mengambil data. Cek console.</div>');
        console.error('Firestore query error:', err);
      }
    });
  </script>
</body>
</html>
