<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Tracking System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 20px;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    .overlay {
      background-color: rgba(0, 0, 0, 0.5);
      min-height: 100vh;
      padding: 30px;
      border-radius: 8px;
    }
    h2 {
      color: #ffcc80;
      text-align: center;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .watermark {
      text-align: center;
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 20px;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333;
      min-width: 140px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
    }
    .dropdown-content button {
      background: none;
      color: white;
      border: none;
      text-align: left;
      padding: 8px 12px;
      width: 100%;
      font-size: 12px;
    }
    .dropdown-content button:hover {
      background-color: #555;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    #filters {
      max-width: 600px;
      margin: 0 auto 15px;
      text-align: center;
    }
    #filters input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: rgba(60, 120, 180, 0.9);
      font-weight: 600;
      color: #fff;
    }
    td {
      background-color: #dcdcdc;
      color: #333;
    }
    tr:nth-child(even) td {
      background-color: #c9c9c9;
    }
    button {
      padding: 6px 12px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      background-color: #ff9800;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 12px;
    }
    button:hover {
      background-color: #e68900;
    }
    .editable {
      background-color: #fff9e0;
      color: #333;
      border-radius: 3px;
    }
    .delete-btn {
      cursor: pointer;
      color: #ff5722;
      font-weight: bold;
      margin-left: 8px;
    }
    .logo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 100px;
      height: auto;
      animation: logoAnim 1.5s ease-in-out infinite alternate;
    }
    @keyframes logoAnim {
      0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
      50% { transform: scale(1.05) rotate(2deg); opacity: 1; }
      100% { transform: scale(1) rotate(-2deg); opacity: 0.9; }
    }
  </style>
</head>
<body>

<div class="overlay">
  <h2>Data Tracking System</h2>
  <div class="watermark">by nazrll</div>

  <div id="loginSection">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <div id="adminSection" style="display:none;">
    <button id="logoutBtn">Logout</button>
    <button id="addRowBtn">+ Tambah Data</button>

    <div class="dropdown">
      <button>Export Data</button>
      <div class="dropdown-content">
        <button id="exportExcel">Excel</button>
        <button id="exportCSV">CSV</button>
      </div>
    </div>

    <div class="dropdown">
      <button>Filter Progress</button>
      <div class="dropdown-content">
        <button id="filterAll">Semua</button>
        <button id="filterDone">Selesai</button>
        <button id="filterPending">Belum Selesai</button>
      </div>
    </div>

    <div id="filters">
      <input type="text" placeholder="Cari No BL, Vessel/Voyage, atau POD" id="mainSearch">
    </div>

    <table id="shipmentTable">
      <thead>
        <tr>
          <th>Bill of Lading</th>
          <th>Vessel / Voyage</th>
          <th>ETA</th>
          <th>Port of Transit</th>
          <th>Connecting Vessel</th>
          <th>ETD</th>
          <th>ETA POD</th>
          <th>Port of Destination</th>
          <th>DO Release Date</th>
          <th>Cargo Release Date</th>
          <th>Progress</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<img src="logo.png" alt="Logo" class="logo">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBwIvGNogDk6nKCCcoWxmnvex4pbSIR07g",
    authDomain: "track-and-trace-ca19a.firebaseapp.com",
    projectId: "track-and-trace-ca19a",
    storageBucket: "track-and-trace-ca19a.appspot.com",
    messagingSenderId: "264766950053",
    appId: "1:264766950053:web:b871670f2ab2c10d0f1b4c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginSection = document.getElementById("loginSection");
  const adminSection = document.getElementById("adminSection");
  const shipmentTableBody = document.querySelector("#shipmentTable tbody");

  document.getElementById("loginBtn").addEventListener("click", () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    signInWithEmailAndPassword(auth, email, password)
      .catch(err => alert("Login gagal: " + err.message));
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth);
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      loginSection.style.display = "none";
      adminSection.style.display = "block";
      loadShipments();
    } else {
      loginSection.style.display = "block";
      adminSection.style.display = "none";
    }
  });

  async function loadShipments() {
    shipmentTableBody.innerHTML = "";
    const querySnapshot = await getDocs(collection(db, "shipments"));
    querySnapshot.forEach(docSnap => {
      addRowToTable(docSnap.id, docSnap.data());
    });
  }

  function addRowToTable(id, data) {
    const tr = document.createElement("tr");
    const fields = [
      "billOfLading","vesselVoyage","eta","portTransit","connectingVessel",
      "etd","etaPod","portDestination","doReleaseDate","cargoReleaseDate"
    ];

    fields.forEach(field => {
      const td = document.createElement("td");
      td.textContent = data[field] || "";
      td.contentEditable = true;
      td.classList.add("editable");
      tr.appendChild(td);
    });

    const progressTd = document.createElement("td");
    const isComplete = fields.every(f => (data[f] || "").trim() !== "");
    progressTd.textContent = isComplete ? "âœ… Selesai" : "âŒ Belum Selesai";
    progressTd.dataset.status = isComplete ? "done" : "pending";
    progressTd.style.color = isComplete ? "green" : "red";
    tr.appendChild(progressTd);

    const actionTd = document.createElement("td");
    const saveBtn = document.createElement("button");
    saveBtn.textContent = "Save";
    saveBtn.addEventListener("click", async () => {
      const updatedData = {};
      fields.forEach((field, index) => {
        updatedData[field] = tr.cells[index].textContent.trim();
      });
      await updateDoc(doc(db, "shipments", id), updatedData);
      alert("Data berhasil disimpan!");
      loadShipments();
    });

    const deleteBtn = document.createElement("span");
    deleteBtn.textContent = "ðŸ—‘";
    deleteBtn.classList.add("delete-btn");
    deleteBtn.addEventListener("click", async () => {
      if (confirm("Yakin hapus data ini?")) {
        await deleteDoc(doc(db, "shipments", id));
        loadShipments();
      }
    });

    actionTd.appendChild(saveBtn);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);
    shipmentTableBody.appendChild(tr);
  }

  document.getElementById("addRowBtn").addEventListener("click", async () => {
    await addDoc(collection(db, "shipments"), {
      billOfLading: "", vesselVoyage: "", eta: "", portTransit: "", connectingVessel: "",
      etd: "", etaPod: "", portDestination: "", doReleaseDate: "", cargoReleaseDate: ""
    });
    loadShipments();
  });

  document.getElementById("mainSearch").addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    const rows = shipmentTableBody.getElementsByTagName("tr");
    for (let row of rows) {
      const bl = row.cells[0].textContent.toLowerCase();
      const vessel = row.cells[1].textContent.toLowerCase();
      const pod = row.cells[7].textContent.toLowerCase();
      row.style.display = (bl.includes(filter) || vessel.includes(filter) || pod.includes(filter)) ? "" : "none";
    }
  });

  document.getElementById("filterAll").addEventListener("click", () => {
    Array.from(shipmentTableBody.rows).forEach(row => row.style.display = "");
  });
  document.getElementById("filterDone").addEventListener("click", () => {
    Array.from(shipmentTableBody.rows).forEach(row => {
      row.style.display = row.cells[10].dataset.status === "done" ? "" : "none";
    });
  });
  document.getElementById("filterPending").addEventListener("click", () => {
    Array.from(shipmentTableBody.rows).forEach(row => {
      row.style.display = row.cells[10].dataset.status === "pending" ? "" : "none";
    });
  });

  document.getElementById("exportExcel").addEventListener("click", () => {
    exportTableToExcel("shipmentTable", "shipment_data");
  });

  document.getElementById("exportCSV").addEventListener("click", () => {
    exportTableToCSV("shipment_data.csv");
  });

  function exportTableToExcel(tableID, filename = "") {
    const dataType = 'application/vnd.ms-excel';
    const tableSelect = document.getElementById(tableID);
    const tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    filename = filename ? filename + '.xls' : 'excel_data.xls';
    const downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
    downloadLink.download = filename;
    downloadLink.click();
  }

  function exportTableToCSV(filename) {
    const csv = [];
    const rows = document.querySelectorAll("table tr");
    for (let i = 0; i < rows.length; i++) {
      const row = [], cols = rows[i].querySelectorAll("td, th");
      for (let j = 0; j < cols.length; j++) {
        row.push(cols[j].innerText);
      }
      csv.push(row.join(","));
    }
    const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    const downloadLink = document.createElement("a");
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.click();
  }
</script>
</body>
</html>
